name: åŠ é€Ÿç‰ˆæž„å»º 6.6.66 Wild_KSU + SCXä¼˜åŒ–å†…æ ¸ (å¢žå¼ºç‰ˆ)

permissions:
  contents: write
  actions: write

env:
  TZ: Asia/Shanghai
  ANDROID_VERSION: 'android15'
  KERNEL_VERSION: '6.6'
  KERNEL_NAME: 'android15-8-g29d86c5fc9dd-wildksu-scx-4k'

on:
  workflow_dispatch:
    inputs: 
      ksu_type:
        description: 'KernelSUåˆ†æ”¯(Wild_KSU/KernelSU Next/MKSU/KSU(åŽŸç‰ˆ)/æ— å†…ç½®KSU,é»˜è®¤Wild_KSU)'
        required: true
        type: choice
        default: 'wildksu'
        options: 
          - 'wildksu'
          - 'ksunext'
          - 'mksu'
          - 'ksu'
          - 'none'
      susfs_enable:
        description: 'æ˜¯å¦å¼€å¯SUSFS(å¢žå¼ºéšè—çŽ¯å¢ƒæŒ‚è½½åŠŸèƒ½)'
        required: true
        type: boolean
        default: 'true'
      kpm_enable:
        description: 'æ˜¯å¦å¼€å¯KPM(builtin-å†…ç½®/kpn-ç‹¬ç«‹å®žçŽ°/false-å…³é—­)'
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'builtin'
          - 'kpn'
      lz4_enable:
        description:  'æ˜¯å¦å¯ç”¨LZ4 1.10.0 + ZSTD 1.5.7è¡¥ä¸'
        required: true
        type: boolean
        default: 'true'
      lz4kd_enable:
        description: 'æ˜¯å¦å¯ç”¨LZ4KDè¡¥ä¸(å¢žå¼ºZRAMåŽ‹ç¼©)'
        required: true
        type: boolean
        default: 'false'
      zram_lz4k_oplus: 
        description: 'æ˜¯å¦å¯ç”¨LZ4K_OPLUSè¡¥ä¸(æœ€å¼ºZRAMä¼˜åŒ–)'
        required: true
        type: boolean
        default: 'true'
      bbr_enable:
        description:  'æ˜¯å¦å¯ç”¨BBRæ‹¥å¡žæŽ§åˆ¶(false/true/default)'
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'true'
          - 'default'
      better_net: 
        description: 'æ˜¯å¦å¯ç”¨ç½‘ç»œåŠŸèƒ½æ‹“å±•(IPSet/Iptables/é«˜çº§é˜²ç«å¢™)'
        required: true
        type: boolean
        default: 'false'
      adios_enable:
        description: 'æ˜¯å¦å¯ç”¨ADIOS IOè°ƒåº¦å™¨(æå‡IOæ€§èƒ½)'
        required: true
        type: boolean
        default: 'true'
      rekernel_enable:
        description:  'æ˜¯å¦å¯ç”¨Re-Kernel(åº”ç”¨å†»ç»“ä¼˜åŒ–)'
        required: true
        type: boolean
        default:  'false'
      baseband_guard: 
        description: 'æ˜¯å¦å¯ç”¨å†…æ ¸çº§åŸºå¸¦ä¿æŠ¤(BBG-é˜²æ­¢æ ¼æœº)'
        required: true
        type: boolean
        default: 'true'
      scx_enable:
        description:  'æ˜¯å¦å¯ç”¨SCXè°ƒåº¦å™¨(HanKuCha SchedExtè¿›ç¨‹è°ƒåº¦ä¼˜åŒ–)'
        required: true
        type: boolean
        default:  'true'
      hmbird_enable:
        description:  'æ˜¯å¦å¯ç”¨HMBIRDè°ƒåº¦å™¨æ”¯æŒ'
        required: true
        type: boolean
        default:  'true'
      optimize_level:
        description: 'ç¼–è¯‘å™¨ä¼˜åŒ–ç­‰çº§(O2/O3)'
        required: true
        type: choice
        default: 'O2'
        options: 
          - 'O2'
          - 'O3'
      lto_mode:
        description: 'LTOä¼˜åŒ–(none/thin/full)'
        required: true
        type: choice
        default: 'none'
        options:
          - 'none'
          - 'thin'
          - 'full'
      clean_build:
        description: 'æ˜¯å¦æ¸…ç©ºç¼–è¯‘ç¼“å­˜(ccache)'
        required: true
        type: boolean
        default: 'false'
      ccache_debug:
        description: 'æ˜¯å¦ä¸Šä¼ Ccacheè°ƒè¯•æ—¥å¿—'
        required: true
        type: boolean
        default:  'false'
      kernel_suffix:
        description: 'å†…æ ¸åŽç¼€(ç•™ç©ºä½¿ç”¨é»˜è®¤)'
        required: false
        type: string
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      ksuver: ${{ steps.ksu_version.outputs.ksuver }}
      kernel_version: ${{ steps.kernel_version.outputs.version }}
    steps:
      - name: ðŸ§¹ ç´§æ€¥ç£ç›˜æ¸…ç†
        run: |
          echo "::group::æ¸…ç†å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ"
          df -h
          echo "::endgroup::"

          echo "::group::ç§»é™¤ä¸å¿…è¦çš„è½¯ä»¶"
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo apt-get clean
          echo "::endgroup::"

          echo "::group::æ¸…ç†åŽç£ç›˜ä½¿ç”¨æƒ…å†µ"
          df -h
          echo "::endgroup::"

      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: ðŸ§¾ è®¾ç½®å†…æ ¸ç‰ˆæœ¬è¾“å‡º
        id: kernel_version
        run: echo "version=${{ env.KERNEL_VERSION }}" >> "$GITHUB_OUTPUT"

      - name: ðŸ“¦ å®‰è£…ç¼–è¯‘ä¾èµ–
        run:  |
          set -euo pipefail
          echo "::group::å®‰è£…ä¾èµ–"
          sudo apt-get -o Acquire::Retries=3 update -qq
          # å…¨é‡å‡çº§ç³»ç»ŸåŒ…ï¼Œå‡å°‘å› ç‰ˆæœ¬è¿‡æ—§å¯¼è‡´çš„ç¼–è¯‘å¼‚å¸¸
          sudo DEBIAN_FRONTEND=noninteractive apt-get -y full-upgrade
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            git curl ca-certificates build-essential clang lld flex bison \
            libelf-dev libssl-dev libncurses-dev zlib1g-dev liblz4-tool \
            libxml2-utils rsync unzip dwarves file python3 ccache jq bc dos2unix kmod libdw-dev elfutils cmake
          sudo apt-get clean
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          echo "::endgroup::"

      - name: ðŸ§° å®‰è£…/å‡çº§ pahole (dwarves v1.31)
        run: |
          set -euo pipefail
          echo "::group::pahole"
          REQUIRED="1.31"
          CURRENT=""
          
          if command -v pahole >/dev/null 2>&1; then
            CURRENT=$(pahole --version | awk '{for (i=1; i<=NF; i++) if ($i ~ /^[0-9]+\\.[0-9]+/) {print $i; exit}}')
          fi
          
          if [ -z "$CURRENT" ] || [ "$(printf '%s\n' "$REQUIRED" "$CURRENT" | sort -V | head -n1)" != "$REQUIRED" ]; then
            echo "Building dwarves v$REQUIRED..."
            rm -rf "$GITHUB_WORKSPACE/dwarves"
            git clone --depth=1 --branch "v$REQUIRED" https://github.com/acmel/dwarves.git "$GITHUB_WORKSPACE/dwarves"
            cmake -S "$GITHUB_WORKSPACE/dwarves" -B "$GITHUB_WORKSPACE/dwarves/build" -DCMAKE_BUILD_TYPE=Release
            cmake --build "$GITHUB_WORKSPACE/dwarves/build" -j"$(nproc --all)"
            echo "$GITHUB_WORKSPACE/dwarves/build" >> "$GITHUB_PATH"
            echo "PAHOLE=$GITHUB_WORKSPACE/dwarves/build/pahole" >> "$GITHUB_ENV"
            export PATH="$GITHUB_WORKSPACE/dwarves/build:$PATH"
          else
            echo "Using system pahole $CURRENT"
          fi
          
          pahole --version
          echo "::endgroup::"

      - name: ðŸ’¾ ç£ç›˜ä½¿ç”¨é¢„æž„å»ºæ£€æŸ¥
        run: |
          echo "::group::æž„å»ºå‰ç£ç›˜ä½¿ç”¨"
          df -h /
          du -sh "$GITHUB_WORKSPACE" 2>/dev/null || true
          sudo rm -rf /tmp/* || true
          echo "::endgroup::"

      - name: âš™ï¸ é…ç½®ccache
        if: ${{ inputs.clean_build != true }}
        run: |
          if command -v ccache >/dev/null 2>&1; then
            echo "::group::ccacheé…ç½®"
            ccache -o max_size=2.0G
            ccache -o compression=true
            ccache -o compression_level=3
            ccache -s
            echo "::endgroup::"
          fi

      - name: ðŸ“¥ åˆå§‹åŒ–æºç åŠå·¥å…·é“¾
        run: |
          rm -rf kernel_workspace
          mkdir kernel_workspace
          cd kernel_workspace
          
          echo "::group::å®‰è£…ä¾èµ–å’Œåˆå§‹åŒ–æºç "
          
          sudo apt-mark hold firefox &&
          sudo apt-mark hold libc-bin &&
          sudo apt purge -y man-db &&
          sudo rm -rf /var/lib/man-db/auto-update &&
          sudo apt update &&
          # å…¨é‡å‡çº§ç³»ç»ŸåŒ…ï¼Œå‡å°‘å› ç‰ˆæœ¬è¿‡æ—§å¯¼è‡´çš„ç¼–è¯‘å¼‚å¸¸
          sudo DEBIAN_FRONTEND=noninteractive apt-get -y full-upgrade &&
          if ! command -v aria2c >/dev/null 2>&1; then
            sudo apt-get install -y --no-install-recommends aria2
          fi
          sudo apt-get install -y --no-install-recommends binutils python-is-python3 libssl-dev libelf-dev ccache
          
          echo "æ­£åœ¨åˆå§‹åŒ–OnePluså†…æ ¸ä»“åº“..."
          REPO=/usr/local/bin/repo
          if [ ! -x "$REPO" ]; then
            sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o "$REPO"
            sudo chmod +x "$REPO"
          fi
          
          "$REPO" init -u https://github.com/OnePlusOSS/kernel_manifest.git -b oneplus/sm8750 -m oneplus_ace_6.xml --repo-rev=v2.16 --depth=1 --no-clone-bundle --no-tags
          "$REPO" --version
          
          success=false
          for i in 1 2 3; do
            if "$REPO" sync -c --no-clone-bundle --no-tags --optimized-fetch -j"$(nproc --all)" --fail-fast; then
              success=true
              break
            fi
            echo "âš ï¸ repo sync attempt $i failed; retrying..."
            sleep 30
          done
          $success || { echo "âŒ repo sync failed"; exit 1; }
          
          if [ ! -f kernel_platform/common/scripts/setlocalversion ]; then
            echo "âŒ kernel_platform/common/scripts/setlocalversion ä¸å­˜åœ¨"
            ls -la kernel_platform/common/scripts || true
            exit 1
          fi
          
          echo "æ­£åœ¨å…‹éš†llvm-clang18å·¥å…·é“¾..."
          mkdir -p clang18 &&
          aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/clang-r510928.zip -o clang.zip &&
          unzip -q clang.zip -d clang18 &&
          rm -rf clang.zip &
          
          echo "æ­£åœ¨å…‹éš†æž„å»ºå·¥å…·..."
          aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/build-tools.zip -o build-tools.zip &&
          unzip -q build-tools.zip &&
          rm -rf build-tools.zip &
          
          wait
          echo "âœ… æ‰€æœ‰æºç åŠå·¥å…·é“¾åˆå§‹åŒ–å®Œæˆ"
          echo "::endgroup::"
          
          echo "::group::ç§»é™¤ABIä¿æŠ¤å’Œdirtyæ ‡è®°"
          rm kernel_platform/common/android/abi_gki_protected_exports_* || true
          rm kernel_platform/msm-kernel/android/abi_gki_protected_exports_* || true
          for f in \
            kernel_platform/common/scripts/setlocalversion \
            kernel_platform/msm-kernel/scripts/setlocalversion \
            kernel_platform/external/dtc/scripts/setlocalversion; do
            if [ -f "$f" ]; then
              sed -i 's/ -dirty//g' "$f"
              sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$f"
            else
              echo "âš ï¸ $f ä¸å­˜åœ¨ï¼Œè·³è¿‡"
            fi
          done
          echo "::endgroup::"

      - name: ðŸ”§ é…ç½®ccacheç›®å½•
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_6.6.66" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=2G" >> $GITHUB_ENV
          echo "å½“å‰ç£ç›˜ç©ºé—´ï¼š"
          df -h

      - name: ðŸ’¾ åŠ è½½ccacheç¼“å­˜
        uses: actions/cache@v4
        id: ccache-restore
        with:
          path:  ${{ env.CCACHE_DIR }}
          key: ccache-wildksu-scx-6.6.66-${{ runner.os }}-main
          restore-keys: |
            ccache-wildksu-scx-6.6.66-${{ runner.os }}-
            ccache-wildksu-scx-6.6.66-

      - name: ðŸŽ¯ åˆå§‹åŒ–å¹¶é…ç½®ccache
        run: |
          export CCACHE_COMPILERCHECK="none"
          export CCACHE_BASEDIR="${{ github.workspace }}"
          export CCACHE_NOHASHDIR="true"
          export CCACHE_HARDLINK="true"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CCACHE_MAXSIZE="${{ env.CCACHE_MAXSIZE }}"
          
          mkdir -p "$CCACHE_DIR"
          echo "é…ç½®ccacheç¼“å­˜å¤§å°ä¸º:  $CCACHE_MAXSIZE"
          ccache -M "$CCACHE_MAXSIZE"
          ccache -o compression=true
          
          echo "ccacheåˆå§‹çŠ¶æ€:"
          ccache -s
          
          if [ "${{ steps.ccache-restore.outputs.cache-hit }}" == 'true' ]; then
            echo "ccacheç¼“å­˜å‘½ä¸­è¯¦æƒ…:"
            ccache -sv
          fi

      - name: ðŸ”Œ æ·»åŠ KernelSU
        id: ksu_version
        run: |
          cd kernel_workspace/kernel_platform
          
          if [[ ${{ github.event.inputs.ksu_type }} == "wildksu" ]]; then
            echo "æ­£åœ¨é…ç½® Wild_KSU..."
            curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh" | bash -s wild
            cd ./Wild_KSU
            
            GIT_COMMIT_HASH=$(git rev-parse --short=8 HEAD)
            echo "å½“å‰æäº¤å“ˆå¸Œ:  $GIT_COMMIT_HASH"
            
            WILD_KSU_VERSION=$(git rev-list --count HEAD 2>/dev/null || echo 1000)
            KSU_VERSION=$(expr $WILD_KSU_VERSION "+" 30000)
            
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
            
            sed -i "s/DKSU_VERSION=16/DKSU_VERSION=${KSU_VERSION}/" kernel/Kbuild || true
            
            echo "Wild_KSUç‰ˆæœ¬å·:  v${KSU_VERSION}-${GIT_COMMIT_HASH}@WildKernels"
            
          elif [[ ${{ github.event.inputs.ksu_type }} == "ksunext" ]]; then
            echo "æ­£åœ¨é…ç½®KernelSU Next..."
            curl -LSs "https://raw.githubusercontent.com/pershoot/KernelSU-Next/refs/heads/dev-susfs/kernel/setup.sh" | bash -s dev-susfs
            cd KernelSU-Next

            KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/pershoot/KernelSU-Next/commits?sha=dev&per_page=1" | grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') "+" 30000)
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT

          elif [[ ${{ github.event.inputs.ksu_type }} == "mksu" ]]; then
            echo "æ­£åœ¨é…ç½® MKSU..."
            curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/refs/heads/main/kernel/setup.sh" | bash -s main
            cd ./KernelSU
            
            KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/5ec1cff/KernelSU/commits?sha=main&per_page=1" | grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') "+" 30000)
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
            
          elif [[ ${{ github.event.inputs.ksu_type }} == "ksu" ]]; then
            echo "æ­£åœ¨é…ç½®åŽŸç‰ˆ KernelSU..."
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/refs/heads/main/kernel/setup.sh" | bash -s main
            cd ./KernelSU
            
            KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/tiann/KernelSU/commits?sha=main&per_page=1" | grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') "+" 30000)
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
            
          else
            echo "å·²é€‰æ‹©æ— å†…ç½®KernelSUæ¨¡å¼ï¼Œè·³è¿‡KernelSUé…ç½®..."
            echo "KSUVER=0" >> $GITHUB_ENV
            echo "ksuver=0" >> $GITHUB_OUTPUT
          fi

      - name:  ðŸ›¡ï¸ åº”ç”¨SUSFSè¡¥ä¸
        if: inputs.susfs_enable
        run: |
          cd kernel_workspace
          echo "::group::åº”ç”¨SUSFSè¡¥ä¸"

          git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
          wget https://github.com/cctv18/oppo_oplus_realme_sm8750/raw/refs/heads/main/other_patch/69_hide_stuff.patch -O ./kernel_platform/common/69_hide_stuff.patch

          cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./kernel_platform/common/
          cp ./susfs4ksu/kernel_patches/fs/* ./kernel_platform/common/fs/ 2>/dev/null || true
          cp ./susfs4ksu/kernel_patches/include/linux/* ./kernel_platform/common/include/linux/ 2>/dev/null || true

          cd ./kernel_platform/common
          patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          patch -p1 < 69_hide_stuff.patch || true

          echo "âœ… SUSFSè¡¥ä¸åº”ç”¨å®Œæˆ"
          echo "::endgroup::"

      - name: ðŸ“¦ åº”ç”¨LZ4 + ZSTDè¡¥ä¸
        if: inputs.lz4_enable
        run: |
          echo "::group::åº”ç”¨LZ4 1.10.0 + ZSTD 1.5.7è¡¥ä¸"
          cd kernel_workspace
          
          git clone --depth=1 https://github.com/cctv18/oppo_oplus_realme_sm8750.git
          cp ./oppo_oplus_realme_sm8750/zram_patch/001-lz4.patch ./kernel_platform/common/
          cp ./oppo_oplus_realme_sm8750/zram_patch/lz4armv8.S ./kernel_platform/common/lib
          cp ./oppo_oplus_realme_sm8750/zram_patch/002-zstd.patch ./kernel_platform/common/
          
          cd ./kernel_platform/common
          git apply -p1 < 001-lz4.patch || true
          patch -p1 < 002-zstd.patch || true
          
          echo "âœ… LZ4 + ZSTDè¡¥ä¸åº”ç”¨å®Œæˆ"
          echo "::endgroup::"

      - name: ðŸ”‹ åº”ç”¨LZ4KDè¡¥ä¸
        if: inputs.lz4kd_enable
        run: |
          echo "::group::åº”ç”¨LZ4KDè¡¥ä¸"
          cd kernel_workspace
          
          PATCH_REPO="Wild_KSU_patch"
          if [ ! -d "$PATCH_REPO" ]; then
            git clone --depth=1 https://github.com/ShirkNeko/SukiSU_patch.git "$PATCH_REPO"
          fi
          
          cd kernel_platform/common
          cp -r "../../$PATCH_REPO/other/zram/lz4k/include/linux/"* ./include/linux/
          cp -r "../../$PATCH_REPO/other/zram/lz4k/lib/"* ./lib
          cp -r "../../$PATCH_REPO/other/zram/lz4k/crypto/"* ./crypto
          cp "../../$PATCH_REPO/other/zram/zram_patch/${{ env.KERNEL_VERSION }}/lz4kd.patch" ./
          patch -p1 -F 3 < lz4kd.patch || true
          
          echo "âœ… LZ4KDè¡¥ä¸åº”ç”¨å®Œæˆ"
          echo "::endgroup::"

      - name: ðŸš€ åº”ç”¨LZ4K_OPLUSè¶…çº§ä¼˜åŒ–è¡¥ä¸
        if:  inputs.zram_lz4k_oplus
        run: |
          echo "::group::åº”ç”¨LZ4K_OPLUSè¶…çº§ä¼˜åŒ–è¡¥ä¸"
          cd kernel_workspace
          
          PATCH_REPO="Wild_KSU_patch"
          if [ ! -d "$PATCH_REPO" ]; then
            git clone --depth=1 https://github.com/ShirkNeko/SukiSU_patch.git "$PATCH_REPO"
          fi
          
          cd kernel_platform/common
          cp -r "../../$PATCH_REPO/other/zram/lz4k/include/linux/"* ./include/linux/ 2>/dev/null || true
          cp -r "../../$PATCH_REPO/other/zram/lz4k/lib/"* ./lib 2>/dev/null || true
          cp -r "../../$PATCH_REPO/other/zram/lz4k/crypto/"* ./crypto 2>/dev/null || true
          cp -r "../../$PATCH_REPO/other/zram/lz4k_oplus" ./lib 2>/dev/null || true
          
          PATCH_FILE="../../$PATCH_REPO/other/zram/zram_patch/${{ env.KERNEL_VERSION }}/lz4k_oplus.patch"
          if [ -f "$PATCH_FILE" ]; then
            patch -p1 -F 3 < "$PATCH_FILE" || echo "âš ï¸ lz4k_oplusè¡¥ä¸åº”ç”¨å¤±è´¥æˆ–å·²åº”ç”¨"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°lz4k_oplusè¡¥ä¸"
          fi
          
          echo "âœ… LZ4K_OPLUSè¡¥ä¸åº”ç”¨å®Œæˆ"
          echo "::endgroup::"

      - name: ðŸ¦ ä¸‹è½½å¹¶é›†æˆSCXè°ƒåº¦å™¨
        if:  inputs.scx_enable
        run: |
          echo "::group::é›†æˆSCXè°ƒåº¦å™¨"
          cd kernel_workspace

          git clone https://github.com/HanKuCha/sched_ext.git
          cp -r ./sched_ext/* ./kernel_platform/common/kernel/sched
          rm -rf ./sched_ext/.git

          cd ./kernel_platform/common/kernel/sched

          [ -f Kconfig ] || touch Kconfig
          if ! grep -q SCHED_CLASS_EXT Kconfig; then
            echo "config SCHED_CLASS_EXT" >> Kconfig
            echo "    bool \"Enable SchedExt (HanKuCha SCX)\"" >> Kconfig
            echo "    default n" >> Kconfig
            echo "    help" >> Kconfig
            echo "      Enable the external SCX scheduler for advanced tuning." >> Kconfig
          fi

          if ! grep -q hmbird_sched_proc_main.o Makefile; then
            echo 'obj-$(CONFIG_SCHED_CLASS_EXT) += hmbird_sched_proc_main.o slim_sysctl.o' >> Makefile
          fi

          # åŽŸè·¯å¾„ï¼šå°‘å›žé€€ä¸€çº§ï¼Œä¼šæŒ‡å‘ common/kernel/arch/...ï¼ˆä¸å­˜åœ¨ï¼‰
          # DEFCONFIG=../arch/arm64/configs/gki_defconfig
          
          # æ–°è·¯å¾„ï¼šä»Ž common/kernel/sched å›žé€€ä¸¤çº§åˆ° common/arch/arm64/configs
          DEFCONFIG=../../arch/arm64/configs/gki_defconfig
          if ! grep -q CONFIG_SCHED_CLASS_EXT "$DEFCONFIG"; then
            echo 'CONFIG_SCHED_CLASS_EXT=y' >> "$DEFCONFIG"
          fi

          echo "âœ… SCXè°ƒåº¦å™¨é›†æˆå®Œæˆ"
          echo "::endgroup::"

      - name: âš™ï¸ æ·»åŠ SUSFSé…ç½®é¡¹
        if: inputs.susfs_enable
        run: |
          cd kernel_workspace
          echo "::group::æ·»åŠ SUSFSé…ç½®"

          echo "CONFIG_KSU_SUSFS=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig

          echo "âœ… SUSFSé…ç½®æ·»åŠ å®Œæˆ"
          echo "::endgroup::"

      - name: ðŸ”§ æ·»åŠ KSUåŠå…¶ä»–é…ç½®é¡¹
        run: |
          cd kernel_workspace
          echo "::group::æ·»åŠ å†…æ ¸é…ç½®é¡¹"
          
          echo "CONFIG_KSU=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          
          if [[ "${{ github.event.inputs.kpm_enable }}" == "builtin" && "${{ github.event.inputs.ksu_type }}" == "wildksu" ]]; then
            echo "CONFIG_KPM=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          fi

          if [[ "${{ github.event.inputs.susfs_enable }}" == "false" ]]; then
            echo "CONFIG_KSU_SUSFS=n" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          fi
          
          echo "CONFIG_TMPFS_XATTR=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          
          # ZRAMé…ç½®
          if [[ "${{ github.event.inputs.lz4kd_enable }}" == "true" || "${{ github.event.inputs.zram_lz4k_oplus }}" == "true" ]]; then
            echo "CONFIG_ZSMALLOC=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_CRYPTO_LZ4HC=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_CRYPTO_LZ4K=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_CRYPTO_LZ4KD=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_CRYPTO_842=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          fi

          if [[ "${{ github.event.inputs.zram_lz4k_oplus }}" == "true" ]]; then
            echo "CONFIG_CRYPTO_LZ4K_OPLUS=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_ZRAM_WRITEBACK=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          fi
          
          # SCXé…ç½®
          if [[ "${{ github.event.inputs.scx_enable }}" == "true" ]]; then
            echo "CONFIG_SCHED_CLASS_EXT=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          fi
          
          # HMBIRDé…ç½®
          if [[ "${{ github.event.inputs.hmbird_enable }}" == "true" ]]; then
            echo "CONFIG_HMBIRD=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          fi

          # ä¼˜åŒ–ç¼–è¯‘
          if [[ "${{ github.event.inputs.optimize_level }}" == "O3" ]]; then
            echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          else
            echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          fi
          
          sed -i 's/check_defconfig//' ./kernel_platform/common/build.config.gki
          echo "CONFIG_HEADERS_INSTALL=n" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          
          echo "âœ… å†…æ ¸é…ç½®é¡¹æ·»åŠ å®Œæˆ"
          echo "::endgroup::"
      
      - name: ðŸ§© é…ç½®LTOä¼˜åŒ–
        run: |
          cd kernel_workspace
          echo "::group::é…ç½®LTO"
          
          DEFCONFIG=./kernel_platform/common/arch/arm64/configs/gki_defconfig
          
          # æ¸…ç†å·²æœ‰ LTO ç›¸å…³é…ç½®ï¼Œé¿å…é‡å¤/å†²çª
          sed -i '/^CONFIG_LTO=/d;/^CONFIG_LTO_/d' "$DEFCONFIG"
          
          case "${{ github.event.inputs.lto_mode }}" in
            none)
              echo "CONFIG_LTO_CLANG_NONE=y" >> "$DEFCONFIG"
              ;;
            thin)
              echo "CONFIG_LTO_CLANG=y" >> "$DEFCONFIG"
              echo "CONFIG_LTO_CLANG_THIN=y" >> "$DEFCONFIG"
              ;;
            full)
              echo "CONFIG_LTO_CLANG=y" >> "$DEFCONFIG"
              echo "CONFIG_LTO_CLANG_FULL=y" >> "$DEFCONFIG"
              ;;
            *)
              echo "âŒ æœªçŸ¥ LTO æ¨¡å¼: ${{ github.event.inputs.lto_mode }}"
              exit 1
              ;;
          esac
          
          echo "âœ… LTOé…ç½®å®Œæˆ: ${{ github.event.inputs.lto_mode }}"
          echo "::endgroup::"

      - name: ðŸŒ å¯ç”¨ç½‘ç»œåŠŸèƒ½å¢žå¼º
        if: inputs.better_net
        run: |
          echo "::group::å¯ç”¨ç½‘ç»œåŠŸèƒ½å¢žå¼º"
          cd kernel_workspace
          
          echo "CONFIG_BPF_STREAM_PARSER=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_NETFILTER_XT_SET=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_MAX=65534" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          
          # IP_SETæ‰€æœ‰å˜ä½“
          for config in BITMAP_IP BITMAP_IPMAC BITMAP_PORT \
                        HASH_IP HASH_IPMARK HASH_IPPORT HASH_IPPORTIP HASH_IPPORTNET \
                        HASH_IPMAC HASH_MAC HASH_NETPORTNET HASH_NET HASH_NETNET \
                        HASH_NETPORT HASH_NETIFACE LIST_SET; do
            echo "CONFIG_IP_SET_$config=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          done
          
          echo "CONFIG_IP6_NF_NAT=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          
          cd kernel_platform/common
          wget https://github.com/cctv18/oppo_oplus_realme_sm8750/raw/refs/heads/main/other_patch/config.patch
          patch -p1 -F 3 < config.patch || true
          
          echo "âœ… ç½‘ç»œåŠŸèƒ½å¢žå¼ºå¯ç”¨å®Œæˆ"
          echo "::endgroup::"

      - name: ðŸš€ æ·»åŠ BBRç­‰æ‹¥å¡žæŽ§åˆ¶ç®—æ³•
        run: |
          if [[ "${{ github.event.inputs.bbr_enable }}" != "false" ]]; then
            echo "::group::æ·»åŠ BBRç­‰æ‹¥å¡žæŽ§åˆ¶ç®—æ³•"
            cd kernel_workspace

            echo "CONFIG_TCP_CONG_ADVANCED=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_BBR=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_CUBIC=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_VEGAS=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_NV=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_WESTWOOD=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_HTCP=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_BRUTAL=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig

            if [[ "${{ github.event.inputs.bbr_enable }}" == "default" ]]; then
              echo "CONFIG_DEFAULT_TCP_CONG=bbr" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
            else
              echo "CONFIG_DEFAULT_TCP_CONG=cubic" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
            fi

            echo "âœ… BBRç­‰æ‹¥å¡žæŽ§åˆ¶ç®—æ³•æ·»åŠ å®Œæˆ"
            echo "::endgroup::"
          fi

      - name: ðŸ’¾ å¯ç”¨ADIOS IOè°ƒåº¦å™¨
        if: inputs.adios_enable
        run:  |
          echo "::group::å¯ç”¨ADIOS IOè°ƒåº¦å™¨"
          cd kernel_workspace

          echo "CONFIG_MQ_IOSCHED_ADIOS=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_MQ_IOSCHED_DEFAULT_ADIOS=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig

          echo "âœ… ADIOS IOè°ƒåº¦å™¨å¯ç”¨å®Œæˆ"
          echo "::endgroup::"

      - name: â„ï¸ å¯ç”¨Re-Kernelæ”¯æŒ
        if: inputs.rekernel_enable
        run:  |
          echo "::group::å¯ç”¨Re-Kernelæ”¯æŒ"
          cd kernel_workspace

          echo "CONFIG_REKERNEL=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig

          echo "âœ… Re-Kernelæ”¯æŒå¯ç”¨å®Œæˆ"
          echo "::endgroup::"

      - name:  ðŸ›¡ï¸ å¯ç”¨å†…æ ¸çº§åŸºå¸¦ä¿æŠ¤
        if: inputs.baseband_guard
        run: |
          echo "::group::å¯ç”¨å†…æ ¸çº§åŸºå¸¦ä¿æŠ¤"
          cd kernel_workspace

          echo "CONFIG_BBG=y" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig

          cd ./kernel_platform/common/security
          wget https://github.com/cctv18/Baseband-guard/archive/refs/heads/master.zip
          unzip -q master.zip
          mv "Baseband-guard-master" baseband-guard
          printf '\nobj-$(CONFIG_BBG) += baseband-guard/\n' >> ./Makefile

          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' ./Kconfig
          
          awk '
          /endmenu/ { last_endmenu_line = NR }
          { lines[NR] = $0 }
          END {
            for (i=1; i<=NR; i++) {
              if (i == last_endmenu_line) {
                sub(/endmenu/, "", lines[i]);
                print lines[i] "source \"security/baseband-guard/Kconfig\""
                print ""
                print "endmenu"
              } else {
                  print lines[i]
              }
            }
          }
          ' ./Kconfig > Kconfig.tmp && mv Kconfig.tmp ./Kconfig
          
          sed -i 's/selinuxfs. o //g' "./selinux/Makefile"
          sed -i 's/hooks. o //g' "./selinux/Makefile"
          cat "./baseband-guard/sepatch.txt" >> "./selinux/Makefile"
          
          echo "âœ… å†…æ ¸çº§åŸºå¸¦ä¿æŠ¤å¯ç”¨å®Œæˆ"
          echo "::endgroup::"

      - name: ðŸ“ æ·»åŠ å†…æ ¸ç‰ˆæœ¬åŽç¼€
        run: |
          cd kernel_workspace
          echo "::group::è®¾ç½®å†…æ ¸ç‰ˆæœ¬åŽç¼€"

          if [[ -n "${{ github.event.inputs.kernel_suffix }}" ]]; then
            SUFFIX="${{ github.event.inputs.kernel_suffix }}"
          else
            SUFFIX="${{ env.KERNEL_NAME }}"
          fi

          for f in ./kernel_platform/common/scripts/setlocalversion; do
            sed -i "\$s|echo \"\\\$res\"|echo \"-$SUFFIX\"|" "$f"
          done

          sudo sed -i "s/-4k/-$SUFFIX/g" ./kernel_platform/common/arch/arm64/configs/gki_defconfig
          sed -i 's/${scm_version}//' ./kernel_platform/common/scripts/setlocalversion
          echo "CONFIG_LOCALVERSION_AUTO=n" >> ./kernel_platform/common/arch/arm64/configs/gki_defconfig

          echo "âœ… å†…æ ¸ç‰ˆæœ¬åŽç¼€è®¾ç½®å®Œæˆ: $SUFFIX"
          echo "::endgroup::"

      - name: ðŸ—ï¸ æž„å»ºå†…æ ¸
        id: kernel_build
        run: |
          WORKDIR="$(pwd)"
          export PATH="/usr/lib/ccache:$PATH"
          export PATH="$WORKDIR/kernel_workspace/clang18/bin:$PATH"
          export PATH="$WORKDIR/kernel_workspace/build-tools/bin:$PATH"
          
          CLANG_DIR="$WORKDIR/kernel_workspace/clang18/bin"
          CLANG_VERSION="$($CLANG_DIR/clang --version | head -n 1)"
          LLD_VERSION="$($CLANG_DIR/ld.lld --version | head -n 1)"

          echo "::group::ç¼–è¯‘å™¨ä¿¡æ¯"
          echo "Clangç‰ˆæœ¬: $CLANG_VERSION"
          echo "LLDç‰ˆæœ¬: $LLD_VERSION"
          echo "::endgroup::"

          export CCACHE_LOGFILE="${{ github.workspace }}/kernel_workspace/ccache.log"
          export CCACHE_COMPILERCHECK="none"
          export CCACHE_BASEDIR="${{ github.workspace }}"
          export CCACHE_NOHASHDIR="true"
          export CCACHE_HARDLINK="true"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CCACHE_MAXSIZE="2G"
          echo "sloppiness = file_stat_matches,include_file_ctime,include_file_mtime,pch_defines,file_macro,time_macros" >> "$CCACHE_DIR/ccache.conf"
          
          cd kernel_workspace/kernel_platform/common

          echo "::group::æ—¶é—´åŠ«æŒåº“ä¸‹è½½"
          wget https://github.com/cctv18/oppo_oplus_realme_sm8750/raw/refs/heads/main/lib/libfakestat.so
          wget https://github.com/cctv18/oppo_oplus_realme_sm8750/raw/refs/heads/main/lib/libfaketimeMT.so
          chmod 777 ./*.so
          export FAKESTAT="2025-05-25 12:00:00"
          export FAKETIME="@2025-05-25 13:00:00"
          SO_DIR=$(pwd)
          export PRELOAD_LIBS="$SO_DIR/libfakestat.so $SO_DIR/libfaketimeMT.so"
          echo "::endgroup::"

          echo "::group::åˆ›å»ºç¼–è¯‘åŒ…è£…å™¨"
          echo '#!/bin/bash' > cc-wrapper
          echo 'export LD_PRELOAD="'$PRELOAD_LIBS'"' >> cc-wrapper
          echo 'export FAKESTAT="'$FAKESTAT'"' >> cc-wrapper
          echo 'export FAKETIME="'$FAKETIME'"' >> cc-wrapper
          echo 'ccache clang "$@"' >> cc-wrapper

          echo '#!/bin/bash' > ld-wrapper
          echo 'export LD_PRELOAD="'$PRELOAD_LIBS'"' >> ld-wrapper
          echo 'export FAKESTAT="'$FAKESTAT'"' >> ld-wrapper
          echo 'export FAKETIME="'$FAKETIME'"' >> ld-wrapper
          echo 'ld.lld "$@"' >> ld-wrapper

          chmod +x cc-wrapper ld-wrapper
          echo "::endgroup::"

          echo "::group::æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶"
          sudo rm -rf /usr/share/dotnet &
          sudo rm -rf /usr/local/lib/android &
          sudo rm -rf /opt/ghc &
          sudo rm -rf /opt/hostedtoolcache/CodeQL &
          wait
          echo "::endgroup::"

          echo "::group::å†…æ ¸ç¼–è¯‘"
          echo "ç¼–è¯‘é…ç½®..."
          make -j$(nproc --all) LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC="ccache clang" LD="ld.lld" HOSTLD=ld.lld O=out KCFLAGS+=-O2 KCFLAGS+=-Wno-error gki_defconfig

          echo "ç¼–è¯‘Image..."
          make -j$(nproc --all) LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC="$(pwd)/cc-wrapper" LD="$(pwd)/ld-wrapper" HOSTLD=ld.lld O=out KCFLAGS+=-O2 KCFLAGS+=-Wno-error Image
          echo "::endgroup::"
          
          echo "ccacheæœ€ç»ˆçŠ¶æ€:"
          ccache -s
          
          echo "::group::ç¼–è¯‘åŽç©ºé—´æ£€æŸ¥"
          df -h
          echo "::endgroup::"

      - name: ðŸ“¦ æ‰“åŒ…AnyKernel3åˆ·æœºåŒ…
        run: |
          cd kernel_workspace

          echo "::group::å‡†å¤‡AnyKernel3"
          git clone https://github.com/cctv18/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          cd AnyKernel3

          cp ../kernel_platform/common/out/arch/arm64/boot/Image ./Image
          if [[ ! -f ./Image ]]; then
            echo "âŒ æœªæ‰¾åˆ°å†…æ ¸é•œåƒæ–‡ä»¶"
            exit 1
          fi
          echo "::endgroup::"

          echo "::group::ç”Ÿæˆåˆ·æœºåŒ…"
          if [[ "${{ github.event.inputs.ksu_type }}" == "wildksu" ]]; then
            KSU_TYPENAME="Wild_KSU"
          elif [[ "${{ github.event.inputs.ksu_type }}" == "ksunext" ]]; then
            KSU_TYPENAME="KSUNext"
          elif [[ "${{ github.event.inputs.ksu_type }}" == "mksu" ]]; then
            KSU_TYPENAME="MKSU"
          elif [[ "${{ github.event.inputs.ksu_type }}" == "ksu" ]]; then
            KSU_TYPENAME="KSU"
          else
            KSU_TYPENAME="none"
          fi

          FEATURES=""
          [[ "${{ github.event.inputs.susfs_enable }}" == "true" ]] && FEATURES+="SUSFS"
          [[ "${{ github.event.inputs.scx_enable }}" == "true" ]] && FEATURES+="_SCX"
          [[ "${{ github.event.inputs.zram_lz4k_oplus }}" == "true" ]] && FEATURES+="_ZRAM"
          [[ "${{ github.event.inputs.adios_enable }}" == "true" ]] && FEATURES+="_ADIOS"
          [[ "${{ github.event.inputs.baseband_guard }}" == "true" ]] && FEATURES+="_BBG"

          if [[ -n "${{ github.event.inputs.kernel_suffix }}" ]]; then
            zip -r ../AnyKernel3_${KSU_TYPENAME}$FEATURES\_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_A15_${{ github.event.inputs.kernel_suffix }}.zip ./*
          else
            zip -r ../AnyKernel3_${KSU_TYPENAME}$FEATURES\_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_A15.zip ./*
          fi

          echo "âœ… åˆ·æœºåŒ…ç”Ÿæˆå®Œæˆ"
          echo "::endgroup::"

      - name: ðŸ“¤ ä¸Šä¼ Ccacheè°ƒè¯•æ—¥å¿—
        if: always() && inputs.ccache_debug
        uses: actions/upload-artifact@v4
        with:
          name:  ccache-debug-log
          path: ${{ github.workspace }}/kernel_workspace/ccache.log

      - name: ðŸ“¤ ä¸Šä¼ ZIPå·¥ä»¶
        uses: actions/upload-artifact@v4
        with:
          name:  Kernel_ZIP_Artifacts
          path: ${{ github.workspace }}/kernel_workspace/AnyKernel*.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: read
    if: ${{ success() }}

    steps:
      - name:  ðŸ“¥ ä¸‹è½½ZIPå·¥ä»¶
        uses: actions/download-artifact@v4
        with:
          name: Kernel_ZIP_Artifacts
          path: ./release_zips

      - name: ðŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          # ðŸŽ¯ å†…æ ¸å‘å¸ƒè¯´æ˜Ž
          
          ## ðŸ“± æž„å»ºä¿¡æ¯
          
          - **æž„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **å†…æ ¸ç‰ˆæœ¬**: ${{ env.KERNEL_VERSION }}.66
          - **KSUç±»åž‹**: ${{ github.event.inputs.ksu_type }}
          - **KSUç‰ˆæœ¬**: v${{ needs.build.outputs.ksuver }}
          - **ç¼–è¯‘ä¼˜åŒ–**: ${{ github.event.inputs.optimize_level }}
          
          ## âœ¨ å¯ç”¨çš„ä¼˜åŒ–
          
          ### Rootç®¡ç†æ–¹æ¡ˆ
          - âœ… **${{ github.event.inputs.ksu_type }}** - KernelSUç®¡ç†æ–¹æ¡ˆ
          
          ### å†…å­˜ä¼˜åŒ–
          - ${{ github.event.inputs.lz4_enable == 'true' && 'âœ…' || 'âŒ' }} LZ4 1.10.0 + ZSTD 1.5.7
          - ${{ github.event.inputs.lz4kd_enable == 'true' && 'âœ…' || 'âŒ' }} LZ4KDè¡¥ä¸
          - ${{ github.event.inputs.zram_lz4k_oplus == 'true' && 'âœ…' || 'âŒ' }} LZ4K_OPLUSè¶…çº§ä¼˜åŒ–

          ### è°ƒåº¦å™¨ä¼˜åŒ–
          - ${{ github.event.inputs.scx_enable == 'true' && 'âœ…' || 'âŒ' }} SCXè°ƒåº¦å™¨ (HanKuCha SchedExt)
          - ${{ github.event.inputs.hmbird_enable == 'true' && 'âœ…' || 'âŒ' }} HMBIRDè°ƒåº¦å™¨
          - ${{ github.event.inputs.adios_enable == 'true' && 'âœ…' || 'âŒ' }} ADIOS IOè°ƒåº¦å™¨

          ### å®‰å…¨éšè—
          - ${{ github.event.inputs.susfs_enable == 'true' && 'âœ…' || 'âŒ' }} SUSFSéšè—åŠŸèƒ½
          - ${{ github.event.inputs.baseband_guard == 'true' && 'âœ…' || 'âŒ' }} å†…æ ¸çº§åŸºå¸¦ä¿æŠ¤(BBG)

          ### ç½‘ç»œä¼˜åŒ–
          - ${{ github.event.inputs.bbr_enable != 'false' && 'âœ…' || 'âŒ' }} BBRæ‹¥å¡žæŽ§åˆ¶ç®—æ³•
          - ${{ github.event.inputs.better_net == 'true' && 'âœ…' || 'âŒ' }} IPSet + é«˜çº§é˜²ç«å¢™æ”¯æŒ

          ### å…¶ä»–ä¼˜åŒ–
          - ${{ github.event.inputs.rekernel_enable == 'true' && 'âœ…' || 'âŒ' }} Re-Kernelåº”ç”¨å†»ç»“
          - âœ… O${{ github.event.inputs.optimize_level }} ç¼–è¯‘ä¼˜åŒ–
          - âœ… Tmpfsæ‰©å±•å±žæ€§æ”¯æŒ(Mountify)
          
          ## ðŸ”— ç›¸å…³é“¾æŽ¥
          
          - [Wild_KSU Manager](https://github.com/WildKernels/Wild_KSU/releases)
          - [KSU SUSFS Module](https://github.com/sidex15/ksu_module_susfs/releases)
          - [Kernel Flasher](https://github.com/fatalcoder524/KernelFlasher/releases)
          
          EOF
          cat release_notes.md

      - name: ðŸ·ï¸ åˆ›å»ºå‘å¸ƒ
        uses: softprops/action-gh-release@v2
        with: 
          tag_name: "6.6.66-wildksu-scx-${{ github.run_number }}"
          name: "å†…æ ¸ 6.6.66 Wild_KSU + SCXä¼˜åŒ–ç‰ˆ Build #${{ github.run_number }}"
          body_path: release_notes.md
          files: release_zips/**/*.zip
          draft: false
          prerelease: false

      - name: ðŸ“Š å‘å¸ƒæ€»ç»“
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ## ðŸŽ‰ å†…æ ¸æž„å»ºå®Œæˆ
          
          **ç‰ˆæœ¬**: 6.6.66 Wild_KSU + SCX
          **KSUç‰ˆæœ¬**: v${{ needs.build.outputs.ksuver }}
          **æ–‡ä»¶æ•°**: $(find ./release_zips -name "*.zip" | wc -l)
          
          ### ðŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶
          
          EOF
          
          for zip in ./release_zips/*.zip; do
            if [ -f "$zip" ]; then
              name=$(basename "$zip")
              size=$(stat -c%s "$zip" | numfmt --to=iec-i --suffix=B 2>/dev/null || stat -c%s "$zip")
              echo "- \`$name\` ($size)" >> $GITHUB_STEP_SUMMARY
            fi
          done

